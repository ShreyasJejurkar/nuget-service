name: Check for NuGet Package Updates

on:
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  check-updates:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Check and download updated NuGet packages
        shell: powershell
        run: |
          powershell -ExecutionPolicy Bypass -File scripts/check-and-update-packages.ps1

      - name: Upload updated packages
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nuget-updated-packages
          path: output/nupkgs
          if-no-files-found: ignore

      - name: Upload update summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: update-summary
          path: output/updates-found.txt
          if-no-files-found: ignore

      - name: Generate short link for artifacts
        shell: powershell
        run: |
          $packagesArtifactUrl = "https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/nuget-updated-packages.zip"
          $summaryArtifactUrl = "https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/update-summary.zip"

          Write-Host "Packages Artifact URL: $packagesArtifactUrl"
          Write-Host "Summary Artifact URL: $summaryArtifactUrl"

          $packageShortLink = $null
          $summaryShortLink = $null

          # Use is.gd for URL shortening
          $service = @{
            name = "is.gd"
            property = "shorturl"
          }

          # Shorten packages artifact URL
          try {
            Write-Host "Attempting to create short link for packages artifact..."
            $url = "https://is.gd/create.php?format=json&url=$([System.Uri]::EscapeDataString($packagesArtifactUrl))"
            $response = Invoke-RestMethod -Uri $url -Method Get -ErrorAction Stop -TimeoutSec 10
            $packageShortLink = $response.$($service.property)
            
            if ([string]::IsNullOrEmpty($packageShortLink)) {
              Write-Host "Empty response from is.gd service"
            } else {
              Write-Host "Successfully created short link: $packageShortLink"
            }
          }
          catch {
            Write-Host "Error with is.gd service: $_"
          }

          # Shorten summary artifact URL
          try {
            Write-Host "Attempting to create short link for summary artifact..."
            $url = "https://is.gd/create.php?format=json&url=$([System.Uri]::EscapeDataString($summaryArtifactUrl))"
            $response = Invoke-RestMethod -Uri $url -Method Get -ErrorAction Stop -TimeoutSec 10
            $summaryShortLink = $response.$($service.property)
            
            if ([string]::IsNullOrEmpty($summaryShortLink)) {
              Write-Host "Empty response from is.gd service"
            } else {
              Write-Host "Successfully created short link: $summaryShortLink"
            }
          }
          catch {
            Write-Host "Error with is.gd service: $_"
          }

          # Write to job summary
          $summary = @"
          ## ðŸ“¦ NuGet Package Update Check

          **Run ID**: ${{ github.run_id }}

          **Workflow**: Check for NuGet Package Updates
          **Status**: Completed

          "@

          if (![string]::IsNullOrEmpty($packageShortLink) -or ![string]::IsNullOrEmpty($summaryShortLink)) {
            $summary += "`n### Download Links`n`n"
            
            if (![string]::IsNullOrEmpty($packageShortLink)) {
              $summary += "ðŸ“¦ **Updated Packages**: [$packageShortLink]($packageShortLink)`n`n"
            } else {
              $summary += "ðŸ“¦ **Updated Packages**: [$packagesArtifactUrl]($packagesArtifactUrl)`n`n"
            }
            
            if (![string]::IsNullOrEmpty($summaryShortLink)) {
              $summary += "ðŸ“‹ **Update Summary**: [$summaryShortLink]($summaryShortLink)`n`n"
            } else {
              $summary += "ðŸ“‹ **Update Summary**: [$summaryArtifactUrl]($summaryArtifactUrl)`n`n"
            }
          } else {
            $summary += "`n### Download Links`n`n"
            $summary += "ðŸ“¦ **Updated Packages**: [$packagesArtifactUrl]($packagesArtifactUrl)`n`n"
            $summary += "ðŸ“‹ **Update Summary**: [$summaryArtifactUrl]($summaryArtifactUrl)`n`n"
          }

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary
          Write-Host "Job summary updated"
