name: Check for NuGet Package Updates

on:
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  check-updates:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Check and download updated NuGet packages
        shell: powershell
        run: |
          powershell -ExecutionPolicy Bypass -File scripts/check-and-update-packages.ps1

      - name: Upload updated packages
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nuget-updated-packages
          path: output/nupkgs
          if-no-files-found: ignore

      - name: Generate short link and update job summary
        shell: powershell
        run: |
          $packagesArtifactUrl = "https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/nuget-updated-packages.zip"
          Write-Host "Packages Artifact URL: $packagesArtifactUrl"

          $packageShortLink = $null

          # Try to shorten packages artifact URL using is.gd
          try {
            Write-Host "Attempting to create short link for packages artifact..."
            $url = "https://is.gd/create.php?format=json&url=$([System.Uri]::EscapeDataString($packagesArtifactUrl))"
            $response = Invoke-RestMethod -Uri $url -Method Get -ErrorAction Stop -TimeoutSec 10
            $packageShortLink = $response.shorturl
            
            if (![string]::IsNullOrEmpty($packageShortLink)) {
              Write-Host "Successfully created short link: $packageShortLink"
            }
          }
          catch {
            Write-Host "Error with is.gd service: $_"
          }

          # Prepare job summary
          $summary = @"
          ## NuGet Package Update Check

          **Run ID**: ${{ github.run_id }}
          **Workflow**: Check for NuGet Package Updates
          **Status**: Completed

          "@

          # Add package download link
          $link = if (![string]::IsNullOrEmpty($packageShortLink)) { $packageShortLink } else { $packagesArtifactUrl }
          $summary += "`n### Downloads`n"
          $summary += "* **Updated Packages (.zip)**: [$link]($link)`n"

          # Include update details from output/updates-found.txt if it exists
          $summaryPath = "output/updates-found.txt"
          if (Test-Path $summaryPath) {
            $updateDetails = Get-Content -Path $summaryPath -Raw
            $summary += "`n### Update Details`n`n$updateDetails"
          } else {
            $summary += "`n### Update Details`nNo package updates were found."
          }

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary
          Write-Host "Job summary updated"
